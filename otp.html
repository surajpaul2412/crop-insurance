<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<title>OTP Verify | DeHaat Insurance</title>
	<!-- Font Awesome -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.2/css/all.css">
	<!-- Google Fonts -->
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap">
	<!-- Bootstrap core CSS -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet">
	<!-- Material Design Bootstrap -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/css/mdb.min.css" rel="stylesheet">
	<!-- custom style -->
	<link rel="stylesheet" type="text/css" href="style.css">
</head>
<body class="bg-grey">
	<section>
		<div class="px-4 height-10">
			<!-- <img src="img/logo-green.png" width="120px" alt="logo"> -->
		</div>
		<div class="px-4 py-4" align="center" style="max-width: 400px;margin: 0 auto;">
			<img src="img/otp.png" class="py-5" width="30%">
			<h2 class="text-dark font-weight-bold">OTP Validation</h2>
			<p>
				A new OTP was generated and sent at [Date and Time] to [Farmer Name] on [Farmer Mobile number]. Please enter the latest verification code to proceed.
			</p>
			<form action="">
				<div id="otp" class="inputs d-flex flex-row justify-content-center mt-2">
		            <input class="m-2 text-center form-control rounded first" type="text" id="first" maxlength="1" />
		            <input class="m-2 text-center form-control rounded second" type="text" id="second" maxlength="1" />
		            <input class="m-2 text-center form-control rounded third" type="text" id="third" maxlength="1" />
		            <input class="m-2 text-center form-control rounded fourth" type="text" id="fourth" maxlength="1" />
		        </div>
		        <div class="mt-4"> <button class="btn btn-success rounded-pill verifyOtp" type="button">Send OTP</button> </div>
		        <div class="mt-4 d-none">
		        	<div class="text-grey font-weight-bold">Didnâ€™t send OTP code?</div>
		        	<a class="text-success font-weight-bold" href=""><u>Resend Code</u></a>
		        </div>
			</form>
		</div>
	</section>

	<!-- The Modal -->
	<div class="modal" id="myModal">
		<form action="">
		  <div class="modal-dialog modal-dialog-centered">
		    <div class="modal-content">

		      <!-- Modal body -->
		      <div class="modal-body pt-4">
		        <h3 align="center" class="text-success font-weight-bold">Verify OTP</h3>
		        <div class="form-group mx-5">
		        	<input type="text" min="4" class="form-control mt-4 otp" id="otp" name="otp">	        	
		        </div>
		      </div>

		      <!-- Modal footer -->
		      <div class="modal-footer" align="center">
		        <button type="button" class="btn btn-primary rounded-pill w-sm-75 d-block mx-auto verifyOtp">Verify</button>
		        <button type="button" class="btn btn-danger rounded-pill w-sm-75 d-block mx-auto" data-dismiss="modal">Later</button>
		      </div>
		    </div>
		  </div>
		</form>
	</div>
	<!-- success -->
	<div class="modal" id="myModalSuccess">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <!-- Modal body -->
	      <div class="modal-body pt-4">
	        <h3 align="center" class="text-success font-weight-bold">Your number successfully Registered</h3>
	      </div>
	      <!-- Modal footer -->
	      <div class="modal-footer" align="center">
	        <button type="button" class="btn btn-success rounded-pill w-sm-75 d-block mx-auto" data-dismiss="modal">Thanks</button>
	      </div>
	    </div>
	  </div>
	</div>
	<!-- failure -->
	<div class="modal" id="myModalFailure">
	  <div class="modal-dialog modal-dialog-centered">
	    <div class="modal-content">
	      <!-- Modal body -->
	      <div class="modal-body pt-4">
	        <h3 align="center" class="text-danger font-weight-bold">Wrong OTP</h3>
	      </div>
	      <!-- Modal footer -->
	      <div class="modal-footer" align="center">
	        <button type="button" class="btn btn-danger rounded-pill w-sm-75 d-block mx-auto" data-dismiss="modal">try Again</button>
	      </div>
	    </div>
	  </div>
	</div>

	<!-- JQuery -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
	<!-- Bootstrap tooltips -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.4/umd/popper.min.js"></script>
	<!-- Bootstrap core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.5.0/js/bootstrap.min.js"></script>
	<!-- MDB core JavaScript -->
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mdbootstrap/4.19.1/js/mdb.min.js"></script>
	<!-- OTP validation -->
	<script>
		document.addEventListener("DOMContentLoaded", function (event) {
		  function OTPInput() {
		    const inputs = document.querySelectorAll("#otp > *[id]");
		    for (let i = 0; i < inputs.length; i++) {
		      inputs[i].addEventListener("keydown", function (event) {
		        if (event.key === "Backspace") {
		          inputs[i].value = "";
		          if (i !== 0) inputs[i - 1].focus();
		        } else {
		          if (i === inputs.length - 1 && inputs[i].value !== "") {
		            return true;
		          } else if (event.keyCode > 47 && event.keyCode < 58) {
		            inputs[i].value = event.key;
		            if (i !== inputs.length - 1) inputs[i + 1].focus();
		            event.preventDefault();
		          } else if (event.keyCode > 64 && event.keyCode < 91) {
		            inputs[i].value = String.fromCharCode(event.keyCode);
		            if (i !== inputs.length - 1) inputs[i + 1].focus();
		            event.preventDefault();
		          }
		        }
		      });
		    }
		  }
		  OTPInput();
		});
	</script>
	<!-- send OTP -->
	<script>
		var link = window.location.href.split("?")[1];
		if(link === undefined){
			window.location.replace("index.html");
		}else{
			var linkSplit = link.split("&");

			// Getting param(name)
			var name = linkSplit[0].split("name=")[1];
			var phone = linkSplit[1].split("phone=")[1];
			var pincode = linkSplit[2].split("pincode=")[1];
			var qr_code = linkSplit[3].split("qr_code=")[1];

			if(phone === undefined){
				window.location.replace("index.html");
			}else{
				// Send OTP
				let personPhone = { "data":{"phone_number": phone,"send_otp_on_non_prod":false} }
		        $.ajax({
		            url: 'https://core.api.agrevolution.in/auth/otp?app_code=dehaat_farmer',
		            type: 'post',
		            dataType: 'json',
		            contentType: 'application/json',
		            data: JSON.stringify(personPhone)
			    });
			}
		}

		// Verify OTP
	    $(".verifyOtp").click(function () {
			let personOtp = { "data":{"phone_number": phone,"otp":$('.first').val()+$('.second').val()+$('.third').val()+$('.fourth').val()} }
	        $.ajax({
	            url: 'https://core.api.agrevolution.in/auth/login?app_code=dehaat_farmer',
	            type: 'post',
	            dataType: 'json',
	            contentType: 'application/json',
	            success: function (data) {
	            	var auth_token = data.data.auth_token;
	            	// Create policy with QR codes
	            	var qr_codeArray = [];
	            	qr_codeArray[0] = qr_code;

	            	let personPolicy = { "qr_codes": qr_codeArray,"pincode":pincode}
	            	$.ajax({
					  url: "https://kheti.api.agrevolution.in/insurance/v1/qr_code",
					  type: 'post',
					  dataType: 'json',
					  contentType: 'application/json',
					  headers: {"Authorization": 'Bearer ' + auth_token},
					  success: function (data){
					  	alert("succ");
					  	console.log(data);
					  	// window.location.replace("thanks.html");
					  },
					  error: function(data){
					  	alert("err");
					  	console.log(data);
					  },
					  data: JSON.stringify(personPolicy)
					});
	            },
	            error: function(data, errorThrown) {
	            	$('#myModalFailure').modal('show');
			    },
	            data: JSON.stringify(personOtp)
	        });
	    });
	</script>
</body>
</html>